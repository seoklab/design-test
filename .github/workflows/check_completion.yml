name: Check Job Completion

on:
  # Run every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-jobs:
    runs-on: [self-hosted, galaxy4]

    permissions:
      issues: write
      contents: write

    env:
      SUBMISSIONS_BASE: /data/galaxy4/user/j2ho/kidds2026/protein-competition/submissions
      PUBLIC_RESULTS: /data/galaxy4/user/j2ho/kidds2026/protein-competition/public_results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check submissions and package results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESULTS_URL: ${{ vars.RESULTS_URL || 'https://seoklab.github.io/design-test/results' }}
          VIEWER_URL: ${{ vars.VIEWER_URL || 'https://seoklab.github.io/design-test/viewer.html' }}
        run: |
          for dir in ${SUBMISSIONS_BASE}/submission_*; do
            if [ ! -d "$dir" ]; then
              continue
            fi

            STATUS_FILE="$dir/status.json"
            if [ ! -f "$STATUS_FILE" ]; then
              continue
            fi

            # Get current status and issue number
            STATUS=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('status', 'unknown'))" 2>/dev/null || echo "unknown")
            ISSUE_NUM=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('issue_number', ''))" 2>/dev/null)

            # Skip if already completed or no issue number
            if [ "$STATUS" = "completed" ] || [ "$STATUS" = "failed" ] || [ -z "$ISSUE_NUM" ]; then
              continue
            fi

            echo "Checking $dir (status: $STATUS, issue: $ISSUE_NUM)..."

            # Check if AF3 output exists (model.cif indicates completion)
            MODEL_FILE=$(find "$dir" -maxdepth 2 -name "*_model.cif" -type f 2>/dev/null | head -1)

            if [ -n "$MODEL_FILE" ]; then
              echo "Found completed output: $MODEL_FILE"

              # Package results with secret token
              python3 scripts/package_results.py \
                --submission-dir "$dir" \
                --output-dir "${PUBLIC_RESULTS}" \
                --status-file "$STATUS_FILE"

              # Get the generated token
              TOKEN=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('result_token', ''))" 2>/dev/null)

              if [ -n "$TOKEN" ]; then
                echo "Results packaged with token: $TOKEN"

                # Comment on issue with private link
                gh issue comment "$ISSUE_NUM" --body "## Results Ready

Your AlphaFold3 prediction has completed!

**View Structure:** [Mol* Viewer](${VIEWER_URL}?token=${TOKEN})
**Download Files:** [Results](${RESULTS_URL}/${TOKEN}/)

> Results are private until the competition ends."

                # Update labels
                gh issue edit "$ISSUE_NUM" --remove-label "processing" --add-label "completed" 2>/dev/null || true

                echo "Notified issue #$ISSUE_NUM"
              fi
            else
              # Check if job failed (log exists but no output)
              LOG_FILE=$(find "$dir/logs" -name "*.log" -type f 2>/dev/null | head -1)
              if [ -n "$LOG_FILE" ]; then
                # Check if log indicates failure
                if grep -q "Error\|FAILED\|Traceback" "$LOG_FILE" 2>/dev/null; then
                  echo "Job appears to have failed"

                  # Update status
                  python3 -c "
import json
with open('$STATUS_FILE', 'r') as f:
    data = json.load(f)
data['status'] = 'failed'
with open('$STATUS_FILE', 'w') as f:
    json.dump(data, f, indent=2)
"

                  gh issue comment "$ISSUE_NUM" --body "## Prediction Failed

There was an error processing your sequence. Please check your input and try again.

If the problem persists, please contact the organizers."

                  gh issue edit "$ISSUE_NUM" --remove-label "processing" --add-label "failed" 2>/dev/null || true
                fi
              fi
            fi
          done
