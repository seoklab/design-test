name: Check Job Completion

on:
  # Run every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-jobs:
    runs-on: [self-hosted, galaxy4]

    permissions:
      issues: write
      contents: write

    env:
      # Stable base directory for all submissions (owned by j2ho)
      SUBMISSIONS_BASE: /data/galaxy4/user/j2ho/kidds2026/protein-competition/submissions
      PUBLIC_RESULTS: /data/galaxy4/user/j2ho/kidds2026/protein-competition/public_results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find processing submissions
        id: find
        run: |
          # Find all submissions with processing or queued status
          PROCESSING_DIRS=""
          for dir in ${SUBMISSIONS_BASE}/submission_*; do
            if [ -d "$dir" ]; then
              STATUS_FILE="$dir/status.json"
              if [ -f "$STATUS_FILE" ]; then
                STATUS=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('status', 'unknown'))" 2>/dev/null || echo "unknown")
                if [ "$STATUS" = "processing" ] || [ "$STATUS" = "submitted" ] || [ "$STATUS" = "queued" ]; then
                  PROCESSING_DIRS="$PROCESSING_DIRS $dir"
                fi
              fi
            fi
          done
          echo "dirs=$PROCESSING_DIRS" >> $GITHUB_OUTPUT

      - name: Check each job
        if: steps.find.outputs.dirs != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESULTS_URL: ${{ vars.RESULTS_URL || 'https://YOUR_GITHUB_PAGES_URL/results' }}
        run: |
          for dir in ${{ steps.find.outputs.dirs }}; do
            echo "Checking $dir..."

            # Read status file
            STATUS_FILE="$dir/status.json"
            if [ ! -f "$STATUS_FILE" ]; then
              continue
            fi

            JOB_ID=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('slurm_job_id', ''))" 2>/dev/null)
            ISSUE_NUM=$(python3 -c "import json; print(json.load(open('$STATUS_FILE')).get('issue_number', ''))" 2>/dev/null)

            if [ -z "$JOB_ID" ] || [ -z "$ISSUE_NUM" ]; then
              echo "Missing job_id or issue_number in $STATUS_FILE"
              continue
            fi

            # Check job status
            python3 scripts/check_job_status.py \
              --submission-dir "$dir" \
              --job-id "$JOB_ID" \
              --results-dir "${PUBLIC_RESULTS}" \
              --output-format json > job_result.json 2>&1 || true

            COMPLETED=$(python3 -c "import json; print(json.load(open('job_result.json')).get('completed', False))")
            SUCCESS=$(python3 -c "import json; print(json.load(open('job_result.json')).get('success', False))")
            TOKEN=$(python3 -c "import json; print(json.load(open('job_result.json')).get('result_token', '') or '')")

            if [ "$COMPLETED" = "True" ]; then
              if [ "$SUCCESS" = "True" ] && [ -n "$TOKEN" ]; then
                # Success - notify participant with private link
                VIEWER_URL="${RESULTS_URL}/../viewer.html?token=${TOKEN}"

                gh issue comment "$ISSUE_NUM" --body "## Results Ready - Your AlphaFold3 prediction completed! **View:** [Mol* Viewer](${VIEWER_URL}) | **Download:** [CIF](${RESULTS_URL}/${TOKEN}/) | Results private until competition ends."
                gh issue edit "$ISSUE_NUM" --remove-label "processing" --add-label "completed"

              else
                # Failed
                ERROR=$(python3 -c "import json; print(json.load(open('job_result.json')).get('error', 'Unknown error'))")

                gh issue comment "$ISSUE_NUM" --body "## Prediction Failed - Error: ${ERROR}. Please check your sequence and try again."
                gh issue edit "$ISSUE_NUM" --remove-label "processing" --add-label "failed"
              fi
            fi

            rm -f job_result.json
          done

      # Results are stored in j2ho's directory, no git commit needed
